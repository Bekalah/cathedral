# GitLab CI/CD Pipeline for Cathedral Real
# Converted from GitHub Actions to GitLab CI format

stages:
  - validate
  - test
  - build
  - deploy-staging
  - deploy-production
  - docs

# Global variables
variables:
  NODE_VERSION: "20.18.0"
  PNPM_VERSION: "8"
  TURBO_VERSION: "1.11.3"

# Validation stage - Pre-deployment checks
validate_environment:
  stage: validate
  image: node:20.18.0
  before_script:
    - npm install -g pnpm@8 turbo@1.11.3
  script:
    - chmod +x scripts/validate-deployment.sh
    - ./scripts/validate-deployment.sh
  artifacts:
    reports:
      junit: validation_*.xml
    paths:
      - validation_*.log
    expire_in: 1 week
  only:
    - main
    - merge_requests

# Test stage - Unit and integration tests
test_packages:
  stage: test
  image: node:20.18.0
  parallel:
    matrix:
      - PACKAGE: ["cataract-book-scanner", "hall-of-ateliers", "cathedral-logo-system", "brain", "arcana"]
  before_script:
    - npm install -g pnpm@8 turbo@1.11.3
    - pnpm install
  script:
    - turbo run test --filter=$PACKAGE
  artifacts:
    reports:
      junit: packages/$PACKAGE/test-results.xml
    paths:
      - packages/$PACKAGE/coverage/
    expire_in: 1 week
  only:
    - main
    - merge_requests

# Build stage - Create production builds
build_packages:
  stage: build
  image: node:20.18.0
  parallel:
    matrix:
      - PACKAGE: ["cataract-book-scanner", "hall-of-ateliers", "cathedral-logo-system"]
  before_script:
    - npm install -g pnpm@8 turbo@1.11.3
    - pnpm install
  script:
    - turbo run build --filter=$PACKAGE
  artifacts:
    paths:
      - packages/$PACKAGE/dist/
    expire_in: 1 month
  only:
    - main
    - merge_requests

# Staging deployment to Render
deploy_staging_render:
  stage: deploy-staging
  image: alpine:latest
  before_script:
    - apk add --no-cache bash curl git
  script:
    - chmod +x scripts/deploy-render.sh
    - export RENDER_SERVICE_ID_CATARACT="$STAGING_RENDER_SERVICE_ID_CATARACT"
    - export RENDER_SERVICE_ID_ATELIERS="$STAGING_RENDER_SERVICE_ID_ATELIERS"
    - export RENDER_SERVICE_ID_LOGO="$STAGING_RENDER_SERVICE_ID_LOGO"
    - ./scripts/deploy-render.sh staging
  environment:
    name: staging
    url: https://cataract-book-scanner-staging.onrender.com
  only:
    - main

# Production deployment to Render
deploy_production_render:
  stage: deploy-production
  image: alpine:latest
  before_script:
    - apk add --no-cache bash curl git
  script:
    - chmod +x scripts/deploy-render.sh
    - export RENDER_API_TOKEN="$PRODUCTION_RENDER_API_TOKEN"
    - export RENDER_SERVICE_ID_CATARACT="$PRODUCTION_RENDER_SERVICE_ID_CATARACT"
    - export RENDER_SERVICE_ID_ATELIERS="$PRODUCTION_RENDER_SERVICE_ID_ATELIERS"
    - export RENDER_SERVICE_ID_LOGO="$PRODUCTION_RENDER_SERVICE_ID_LOGO"
    - ./scripts/deploy-render.sh production
  environment:
    name: production
    url: https://cataract-book-scanner.onrender.com
  only:
    - tags

# Deploy to Vercel
deploy_vercel:
  stage: deploy-staging
  image: node:20.18.0
  before_script:
    - npm install -g vercel@latest
  script:
    - chmod +x scripts/deploy-vercel.sh
    - export VERCEL_TOKEN="$VERCEL_TOKEN"
    - ./scripts/deploy-vercel.sh production
  environment:
    name: vercel
    url: https://cataract-book-scanner.vercel.app
  only:
    - main

# Deploy to Cloudflare Pages
deploy_cloudflare:
  stage: deploy-staging
  image: node:20.18.0
  before_script:
    - npm install -g wrangler@latest
  script:
    - chmod +x scripts/deploy-cloudflare.sh
    - export CLOUDFLARE_API_TOKEN="$CLOUDFLARE_API_TOKEN"
    - export CLOUDFLARE_ACCOUNT_ID="$CLOUDFLARE_ACCOUNT_ID"
    - ./scripts/deploy-cloudflare.sh
  environment:
    name: cloudflare
    url: https://cataract-book-scanner.pages.dev
  only:
    - main

# Documentation deployment
deploy_docs:
  stage: docs
  image: node:20.18.0
  before_script:
    - npm install -g pnpm@8
    - pnpm install
  script:
    - turbo run docs:build
    - turbo run docs:deploy
  artifacts:
    paths:
      - packages/*/docs/
  only:
    - main
    - merge_requests

# Godot deployment (for game packages)
deploy_godot:
  stage: deploy-staging
  image: ubuntu:22.04
  before_script:
    - apt-get update && apt-get install -y unzip
    - wget https://github.com/godotengine/godot/releases/download/4.2.1/Godot_v4.2.1_linux.x86_64.zip
    - unzip Godot_v4.2.1_linux.x86_64.zip
  script:
    - chmod +x Godot_v4.2.1_linux.x86_64/Godot_v4.2.1_linux.x86_64
    - turbo run godot:build --filter="godot-*"
    - turbo run godot:deploy --filter="godot-*"
  environment:
    name: godot-cloud
  only:
    - main
    - merge_requests
  when: manual

# Health check job
health_check:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Performing health checks..."
    - curl -f https://cataract-book-scanner.onrender.com/ || exit 1
    - curl -f https://hall-of-ateliers.onrender.com/ || exit 1
    - curl -f https://cathedral-logo-system.onrender.com/ || exit 1
    - echo "All services are healthy!"
  only:
    - main
    - merge_requests