<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Cathedral Hub — Corpus Integration</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="color-scheme" content="dark light">
  <style>
    :root {
      --bg: #0e0e18;
      --panel: #151524;
      --ink: #f0f0ff;
      --muted: #b1b1c9;
      --accent: #88d4ab;
      --accent-soft: rgba(136, 212, 171, 0.16);
      --line: #26263a;
    }
    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--ink);
      font: 15px/1.5 "IBM Plex Sans", system-ui, sans-serif;
    }
    header {
      padding: 16px;
      border-bottom: 1px solid var(--line);
    }
    main {
      padding: 16px;
      display: grid;
      gap: 16px;
      max-width: 960px;
      margin: 0 auto;
    }
    section {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 16px;
    }
    h1 {
      font-size: 1.4rem;
      margin: 0 0 8px;
    }
    h2 {
      font-size: 1.1rem;
      margin: 0 0 12px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: var(--muted);
    }
    input[type="search"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid var(--line);
      background: #101022;
      color: var(--ink);
    }
    ul.results {
      list-style: none;
      margin: 12px 0 0;
      padding: 0;
      display: grid;
      gap: 8px;
    }
    ul.results li {
      padding: 10px 12px;
      border-radius: 6px;
      background: #11112a;
      border: 1px solid #1e1e33;
    }
    .status {
      color: var(--muted);
      font-size: 0.85rem;
    }
    button {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
      cursor: pointer;
    }
    button.active {
      background: var(--accent);
      color: #0b0b0f;
    }
    button:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    .grid {
      display: grid;
      gap: 12px;
    }
    .grid.two {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
    figure {
      margin: 0;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 6px;
      background: #111120;
      text-align: center;
    }
    figure img {
      max-width: 100%;
      height: auto;
    }
    dialog {
      border: none;
      border-radius: 10px;
      padding: 20px;
      background: #111120;
      color: var(--ink);
      max-width: 560px;
    }
    dialog::backdrop {
      background: rgba(11, 11, 16, 0.6);
    }
    .packet-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }
    .packet-card {
      padding: 10px;
      border: 1px solid var(--line);
      border-radius: 6px;
      background: #101028;
    }
  </style>
</head>
<body>
  <header>
    <h1>Cathedral Hub</h1>
    <p class="status" id="status">Loading corpus…</p>
  </header>
  <main>
    <section>
      <h2>Corpus Search</h2>
      <label for="corpusSearch">Search canonical works, symbols, and node packs.</label>
      <input id="corpusSearch" type="search" placeholder="Search for Venus, Netzach, or Empress">
      <ul class="results" id="searchResults"></ul>
    </section>

    <section class="grid two">
      <div>
        <h2>Node Actions</h2>
        <p>Trigger source packs from any mode.</p>
        <button data-pack="C144N-000">Open Sources (Node)</button>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button data-mode="study" class="active">Study Mode</button>
          <button data-mode="art">Art Mode</button>
          <button data-mode="adventure">Adventure Mode</button>
        </div>
      </div>
      <div>
        <h2>Ritual Packet</h2>
        <div id="ritualPacket" class="packet-grid"></div>
      </div>
    </section>

    <section>
      <h2>Tarot & Circuitum</h2>
      <div class="grid two">
        <div>
          <h3>Tarot Card</h3>
          <p>The Empress — align with Netzach.</p>
          <button data-pack="C144N-000">Sources (Tarot)</button>
        </div>
        <div>
          <h3>Circuitum Passage</h3>
          <p>"The gate opens on a field of emerald; breathe and return whole."</p>
          <button data-pack="C144N-000">Sources (Passage)</button>
        </div>
      </div>
    </section>

    <section>
      <h2>IIIF Plate Preview</h2>
      <p>Offline by default; click to request when online.</p>
      <button id="loadIiif">Load Monas Plate</button>
      <figure id="iiifFigure" style="margin-top:12px;"><figcaption>IIIF plate will appear here.</figcaption></figure>
    </section>
  </main>

  <dialog id="sourceModal">
    <div id="modalBody"></div>
    <button id="closeModal" style="margin-top:16px;">Close</button>
  </dialog>

  <script type="module">
    import { initCorpus, attachCorpusSearch } from "./js/corpus.js";
    import { setModalRenderer, showSourcePack } from "./js/source-packs.js";
    import { iiifImage } from "./js/iiif.js";
    import { loadRitualData, createRitualBridge } from "./js/tesseract.js";

    const statusEl = document.getElementById("status");
    const modal = document.getElementById("sourceModal");
    const modalBody = document.getElementById("modalBody");
    const closeModal = document.getElementById("closeModal");

    function renderSearchItem(item) {
      const meta = [];
      if (item.author) meta.push(item.author);
      if (item.node) meta.push(item.node);
      if (item.type) meta.push(item.type.replace(/_/g, " "));
      const subtitle = meta.length ? `<small>${meta.join(" · ")}</small>` : "";
      return `<li><strong>${item.title || item.id}</strong><br>${subtitle}<br><small>${item.summary || ""}</small></li>`;
    }

    function renderPacket(packet, mode) {
      if (!packet) {
        return;
      }
      const items = [
        { label: "Mode", value: mode },
        { label: "Sephira", value: packet.sephira },
        { label: "Planet", value: packet.planet },
        { label: "Tarot", value: packet.tarot.join(", ") },
        { label: "Angels", value: packet.angels.join(", ") },
        { label: "Demons", value: packet.demons.join(", ") },
        { label: "Seals", value: packet.seals.join(", ") }
      ];
      const html = items
        .filter(item => item.value && item.value.length !== 0)
        .map(item => `<div class="packet-card"><strong>${item.label}</strong><br><span>${item.value}</span></div>`)
        .join("");
      document.getElementById("ritualPacket").innerHTML = html;
    }

    function initModal() {
      if (!modal || !modalBody || !closeModal || !modal.showModal) {
        return () => {};
      }
      closeModal.addEventListener("click", () => modal.close());
      setModalRenderer(html => {
        modalBody.innerHTML = html;
        modal.showModal();
      });
      return () => modal.close();
    }

    async function boot() {
      const mini = await initCorpus();
      statusEl.textContent = mini ? "Corpus ready." : "Corpus index missing; fallback active.";

      attachCorpusSearch({
        input: "#corpusSearch",
        results: "#searchResults",
        renderResult: renderSearchItem
      });

      initModal();

      document.querySelectorAll("[data-pack]").forEach(button => {
        button.addEventListener("click", () => {
          const id = button.dataset.pack;
          showSourcePack(id);
        });
      });

      const ritualData = await loadRitualData();
      const bridge = createRitualBridge({
        correspondences: ritualData.correspondences,
        symbols: ritualData.symbols,
        onPacket: renderPacket
      });

      const nodeData = { id: "C144N-000", title: "Fool – Alpha", sephira: "Netzach", planet: "Venus" };
      bridge.setNode(nodeData);

      document.querySelectorAll("[data-mode]").forEach(button => {
        button.addEventListener("click", () => {
          document.querySelectorAll("[data-mode]").forEach(btn => btn.classList.toggle("active", btn === button));
          bridge.setMode(button.dataset.mode);
        });
      });

      const iiifButton = document.getElementById("loadIiif");
      const iiifFigure = document.getElementById("iiifFigure");
      iiifButton.addEventListener("click", async () => {
        const manifest = await fetch("../shared/corpus/images/manifests/dee_monas.json", { cache: "no-store" })
          .then(response => (response.ok ? response.json() : null))
          .catch(() => null);
        const url = iiifImage(manifest, 600);
        if (url) {
          iiifFigure.innerHTML = `<img src="${url}" alt="Monas Hieroglyphica plate"><figcaption>Monas Hieroglyphica (IIIF)</figcaption>`;
        } else {
          iiifFigure.innerHTML = "<p>Unable to derive IIIF image offline.</p>";
        }
      });
    }

    boot();
  </script>
</body>
</html>
