name: Cathedral Real CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [created]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'pnpm'

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}

    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

    - name: Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Run linting
      run: pnpm lint

    - name: Run type checking
      run: pnpm type-check

    - name: Run tests
      run: pnpm test

    - name: Validate Cathedral packages
      run: |
        echo "Validating @cathedral scoped packages..."
        pnpm --filter @cathedral/* run validate

    - name: Check package.json integrity
      run: |
        echo "Checking package.json files for @cathedral scope consistency..."
        for pkg in packages/@cathedral/*/package.json; do
          if [ -f "$pkg" ]; then
            name=$(jq -r '.name' "$pkg")
            if [[ ! "$name" =~ ^@cathedral/ ]]; then
              echo "❌ Package $name does not use @cathedral scope"
              exit 1
            else
              echo "✅ Package $name has correct @cathedral scope"
            fi
          fi
        done

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Generate version
      id: version
      run: |
        # Generate version based on semantic-release
        if [ "${{ github.event_name }}" = "release" ]; then
          echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
        else
          echo "version=1.0.0-dev.$(date +%Y%m%d).${{ github.sha }}" >> $GITHUB_OUTPUT
        fi

    - name: Build packages
      run: pnpm build

    - name: Build apps
      run: |
        pnpm --filter @cathedral/cathedral-web-app build || echo "Web app build failed, continuing..."
        pnpm --filter @cathedral/cataract-book-scanner build || echo "Scanner build failed, continuing..."

    - name: Create release artifacts directory
      run: mkdir -p release-artifacts

    - name: Package built packages
      run: |
        for pkg_dir in packages/@cathedral/*/; do
          if [ -d "$pkg_dir/dist" ]; then
            pkg_name=$(basename "$pkg_dir")
            cd "$pkg_dir"
            npm pack --pack-destination ../../release-artifacts
            cd ../..
          fi
        done

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: |
          packages/**/dist/
          apps/**/dist/
          release-artifacts/*.tgz
        retention-days: 30

  deploy-pages:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: ./dist

    - name: Setup Pages
      uses: actions/configure-pages@v5

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      with:
        artifact_name: build-files

  semantic-release:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    outputs:
      released: ${{ steps.release.outputs.released }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}

    - name: Install dependencies
      run: |
        pnpm install --frozen-lockfile
        pnpm add -Dw @semantic-release/changelog @semantic-release/git @semantic-release/github @semantic-release/npm

    - name: Run semantic-release
      id: release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      run: npx semantic-release

    - name: Output release info
      run: |
        echo "Released: ${{ steps.release.outputs.released }}"
        echo "Version: ${{ steps.release.outputs.version }}"

  publish-packages:
    needs: [build, semantic-release]
    runs-on: ubuntu-latest
    if: needs.semantic-release.outputs.released == 'true'
    environment:
      name: npm-publish
      url: ${{ steps.publish-npm.outputs.package-url }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        registry-url: 'https://registry.npmjs.org'

    - name: Setup GitHub Packages
      run: |
        echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_PACKAGES_TOKEN }}" >> ~/.npmrc
        echo "always-auth=true" >> ~/.npmrc

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Download release artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: ./release-artifacts

    - name: Publish to NPM
      id: publish-npm
      run: |
        echo "Publishing @cathedral/* packages to NPM registry..."
        cd release-artifacts
        for pkg in *.tgz; do
          if [ -f "$pkg" ]; then
            echo "Publishing $pkg to NPM..."
            npm publish "$pkg" --access public
          fi
        done
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    - name: Publish to GitHub Packages
      id: publish-github
      run: |
        echo "Publishing @cathedral/* packages to GitHub Packages..."
        cd release-artifacts
        for pkg in *.tgz; do
          if [ -f "$pkg" ]; then
            echo "Publishing $pkg to GitHub Packages..."
            npm publish "$pkg" --registry=https://npm.pkg.github.com/ --access public
          fi
        done
      env:
        NODE_AUTH_TOKEN: ${{ secrets.GITHUB_PACKAGES_TOKEN }}

    - name: Validate published packages
      run: |
        echo "Validating published packages..."
        # Test package installation from both registries
        npm install @cathedral/types --registry=https://registry.npmjs.org/
        npm install @cathedral/types --registry=https://npm.pkg.github.com/
        echo "✅ Package validation successful"

  test-publish:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    continue-on-error: true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        registry-url: 'https://registry.npmjs.org'

    - name: Setup GitHub Packages
      run: |
        echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_PACKAGES_TOKEN }}" >> ~/.npmrc || echo "GitHub token not available"
        echo "always-auth=true" >> ~/.npmrc

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Build test packages
      run: pnpm build

    - name: Test package structure
      run: |
        echo "Testing package structure for @cathedral scoped packages..."
        for pkg_dir in packages/@cathedral/*/; do
          if [ -d "$pkg_dir" ]; then
            pkg_name=$(basename "$pkg_dir")
            echo "Checking $pkg_name structure..."
            
            # Check for required files
            if [ ! -f "$pkg_dir/package.json" ]; then
              echo "❌ Missing package.json in $pkg_name"
              exit 1
            fi
            
            # Validate package.json
            jq empty "$pkg_dir/package.json" || exit 1
            
            # Check if build output exists
            if [ -d "$pkg_dir/dist" ]; then
              echo "✅ $pkg_name has build output"
            else
              echo "⚠️  $pkg_name missing build output"
            fi
          fi
        done

    - name: Test package installation (dry run)
      run: |
        echo "Testing package installation from both registries..."
        
        # Test NPM registry
        npm view @cathedral/types version || echo "Package not yet published to NPM"
        
        # Test GitHub Packages registry
        npm view @cathedral/types version --registry=https://npm.pkg.github.com/ || echo "Package not yet published to GitHub Packages"

  security-audit:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Run security audit
      run: |
        echo "Running security audit on all packages..."
        pnpm audit --audit-level moderate
        
        echo "Checking for known vulnerabilities in @cathedral packages..."
        for pkg_dir in packages/@cathedral/*/; do
          if [ -f "$pkg_dir/package.json" ]; then
            pkg_name=$(jq -r '.name' "$pkg_dir/package.json")
            echo "Auditing $pkg_name dependencies..."
            cd "$pkg_dir"
            npm audit --audit-level moderate || echo "Vulnerabilities found in $pkg_name"
            cd ../..
          fi
        done

    - name: Check for banned language patterns
      run: |
        echo "Checking for banned Cathedral language patterns..."
        banned_patterns=(
          "therapy\|therapeutic\|clinical"
          "guru\|master\|enlightenment"
          "500x\|exponential.*growth\|magic.*bullet"
          "AI.*oracle\|AI.*guru\|AI.*master"
        )
        
        for pattern in "${banned_patterns[@]}"; do
          if grep -r -i "$pattern" packages/ docs/ --exclude-dir=node_modules --exclude="*.json" --exclude="*.lock"; then
            echo "❌ Found banned pattern: $pattern"
            exit 1
          fi
        done
        echo "✅ No banned language patterns found"

    - name: Validate trauma-safety configuration
      run: |
        echo "Validating trauma-safety configuration..."
        for pkg_dir in packages/@cathedral/*/; do
          if [ -f "$pkg_dir/package.json" ]; then
            trauma_safe=$(jq -r '.cathedral.trauma_safety // {} | tostring' "$pkg_dir/package.json")
            if [[ "$trauma_safe" == *"{}"* ]]; then
              echo "⚠️  Missing trauma-safety config in $(basename "$pkg_dir")"
            else
              echo "✅ Trauma-safety config found in $(basename "$pkg_dir")"
            fi
          fi
        done